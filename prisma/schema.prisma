generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  name            String
  createdAt       DateTime         @default(now())
  password        String
  role            Role             @default(BORROWER)
  status          String?
  updatedAt       DateTime         @updatedAt
  user_id         String           @id @db.VarChar(32)
  username        String           @unique
  email           String?
  noHandphone     String?
  authentications Authentication[]
  loans           Loan[]           @relation("UserLoans")
  loanDetails     LoanDetail[]     @relation("BorrowerDetails")
}

model Category {
  category_id   String    @id @db.VarChar(32)
  category_name String    @unique
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  products      Product[]
}

model Product {
  product_id      String       @id @db.VarChar(32)
  product_name    String       @unique
  product_image   String?
  quantity        Int
  category_id     String
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  product_avaible Int
  loanDetails     LoanDetail[]
  category        Category     @relation(fields: [category_id], references: [category_id], onDelete: Cascade)
}

model Loan {
  loan_id     String        @id @db.VarChar(32)
  user_id     String
  loan_date   DateTime      @default(now())
  return_date DateTime?
  status      LoanStatus    @default(REQUESTED)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  user        User          @relation("UserLoans", fields: [user_id], references: [user_id], onDelete: Cascade)
  details     LoanDetail[]
  histories   LoanHistory[]
}

model LoanDetail {
  loan_detail_id String   @id @db.VarChar(32)
  loan_id        String
  product_id     String
  quantity       Int
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  image_path     String
  borrower_id    String
  borrower       User     @relation("BorrowerDetails", fields: [borrower_id], references: [user_id], onDelete: Cascade)
  loan           Loan     @relation(fields: [loan_id], references: [loan_id], onDelete: Cascade)
  product        Product  @relation(fields: [product_id], references: [product_id])

  @@index([loan_id])
  @@index([product_id])
  @@index([borrower_id])
}

model LoanHistory {
  history_id String   @id @db.VarChar(32)
  loan_id    String
  activity   String
  timestamp  DateTime @default(now())
  loan       Loan     @relation(fields: [loan_id], references: [loan_id], onDelete: Cascade)

  @@index([loan_id])
}

model Authentication {
  id        String   @id @db.VarChar(32)
  user_id   String
  token     String   @unique
  createdAt DateTime @default(now())
  user      User     @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
}

enum Role {
  SUPERADMIN
  ADMIN
  BORROWER
}

enum LoanStatus {
  REQUESTED
  APPROVED
  REJECTED
  RETURNED
}
